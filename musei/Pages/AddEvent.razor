@page "/addevent"

@using Radzen
@using Microsoft.Maui.Graphics
@using System.Text.Json
@using musei.Data
@inject CosmosService cs
@inject Session sess
@inject NotificationService NotificationService

<RadzenNotification />
<link rel="stylesheet" href="~/@(nameof(musei)).styles.css" />
<style>
    .flexColumn {
        display: flex;
        flex-direction: column;
        justify-content: space-around;
    }

    .inputMargin {
        margin: 10px;
    }
</style>

<br />


<h3>Add Event To @sess.currentMuseum.name</h3>

<RadzenCard class="flexColumn">
    <RadzenTemplateForm Submit=@OnSubmit 
                        InvalidSubmit=@OnInvalidSubmit
                        TItem="Event"
                        Data=@newEvent>
        <RadzenTextBox  Placeholder="Title" Class="w-100" @bind-Value=@newEvent.name Name="title"/>
        <RadzenRequiredValidator Component="title" Text="Title is required" Popup=false Style="position: static" />
        <RadzenDatePicker TValue="DateTime?" ShowTime="true" HoursStep="1" MinutesStep="15" DateFormat="MM/dd/yyyy HH:mm" Class="w-100" @bind-Value=@startTime Placeholder ="Date" Name="date"/>
        <RadzenRequiredValidator Component="date" Text="Date is required" Popup=false Style="position: static" />
        <RadzenTextArea Placeholder="Description" Class="w-100" Rows="12" @bind-Value=@newEvent.description Name="description"/>
        <RadzenRequiredValidator Component="description" Text="Description is required" Popup=false Style="position: static" />
        <RadzenNumeric TValue="int?" Placeholder="Price" Class="w-100" @bind-Value=@price Name="price"/>
        <RadzenRequiredValidator Component="price" Text="Price is required" Popup=false Style="position: static" />
        <RadzenFileInput @bind-Value=@photo @bind-FileName=@fileName TValue="string" Class="w-100" ChooseText="Select Image" Name="photo"/>
        <RadzenRequiredValidator Component="photo" Text="Image is required" Popup=false Style="position: static" />
        <RadzenButton Text="Submit" Class="w-100"
                      IsBusy=@busy
                      ButtonType="ButtonType.Submit" />
    </RadzenTemplateForm>
</RadzenCard>

@code {

    DateTime? startTime;
    int? price;
    public Event newEvent = new Event();
    public string photo;
    public string fileName;
    bool busy = false;

    async void OnSubmit()
    {
            
            busy = true;
            newEvent.startTime = (DateTime)startTime;
            newEvent.price = (int)price;
            newEvent.id = Guid.NewGuid().ToString("N");
            newEvent.imageURL = photo.Substring(photo.IndexOf("data:image/"));
            newEvent.museum = sess.currentMuseum.id;
            await cs.UploadEvent(newEvent);
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Event Creation Successful", Duration = 40000 });
            await Task.Delay(2000);
            await App.Current.MainPage.Navigation.PopToRootAsync();
    }

    void OnInvalidSubmit(FormInvalidSubmitEventArgs args){}
    
 }
